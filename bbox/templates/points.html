{% extends "base.html" %}
{% block scripts %}
<script type="text/javascript">
var endPoint1, endPoint2, rectangle, map, markersArray = [];
function initialize() {
    var latLng = new google.maps.LatLng(-34.397, 150.644);
    var mapOptions = {
	center: latLng,
	zoom: 8,
	mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
    endPoint1 = new google.maps.Marker( {
	map: map,
	position: new google.maps.LatLng(-35,150),
	draggable: true,
	title: "Drag me!"
    } );
    endPoint2 = new google.maps.Marker( {
	map: map,
	position: new google.maps.LatLng(-34,151),
	draggable: true,
	title: "Drag me!"
    } );

    // Callbacks for moving rectangle
    google.maps.event.addListener( endPoint1, 'dragend', redraw );
    google.maps.event.addListener( endPoint2, 'dragend', redraw );
    // Callback for clicking on the map
    google.maps.event.addListener( map, 'click', addPoint );

    // Create a rectangle overlay and place it on the map
    rectangle = new google.maps.Rectangle( {
	map: map
    } );

    // Callback for clicking on the rectangle overlay
    google.maps.event.addListener( rectangle, 'click', addPoint );

    redraw();
}

function addPoint( mouseEvent ) {
    $.ajax( {
	type: "POST",
	url: "/point/add/",
	data: { 'lat': mouseEvent.latLng.lat(),
		'lng': mouseEvent.latLng.lng() },
	success: function() {
	    displayPoint( mouseEvent.latLng );
	}
    } );
}

function displayPoint( latLng ) {
    var marker = new google.maps.Marker( {
    	position: latLng,
    	map: map,
    	title: "point you made"
    } );
    markersArray.push( marker );
}

function clearMarkers() {
    for ( var i=0; i<markersArray.length; i++ ) {
	markersArray[i].setMap( null );
	markersArray[i].setVisible( false );
    }
    markersArray = new Array();
}

function redraw() {
    var latLngBounds = new google.maps.LatLngBounds(
	endPoint1.getPosition(),
	endPoint2.getPosition()
    );
    rectangle.setBounds( latLngBounds );

    $.ajax( {
	type: "GET",
	url: "/point/search/",
	data: { 'lat1': endPoint1.getPosition().lat(),
		'lng1': endPoint1.getPosition().lng(),
		'lat2': endPoint2.getPosition().lat(),
		'lng2': endPoint2.getPosition().lng() },
	success: function( data ) {
	    clearMarkers();
	    for ( var i=0; i<data.length; i++ ) {
		displayPoint( new google.maps.LatLng(data[i][0], data[i][1]) );
	    }
	}
    } );
	    
}

function getCSRF() {
    return $.cookie('csrftoken');
}

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

function sameOrigin(url) {
    // test that a given url is a same-origin URL
    // url could be relative or scheme relative or absolute
    var host = document.location.host; // host + port
    var protocol = document.location.protocol;
    var sr_origin = '//' + host;
    var origin = protocol + sr_origin;
    // Allow absolute or scheme relative URLs to same origin
    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
        // or any other URL that isn't scheme relative or absolute i.e relative.
        !(/^(\/\/|http:|https:).*/.test(url));
}

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
            // Send the token to same-origin, relative URLs only.
            // Send the token only if the method warrants CSRF protection
            // Using the CSRFToken value acquired earlier
            xhr.setRequestHeader("X-CSRFToken", getCSRF() );
        }
    }
});
$(document).ready( initialize );
</script>
{% endblock %}

{% block content %}
<div id="map_canvas"></div>
{% endblock %}
